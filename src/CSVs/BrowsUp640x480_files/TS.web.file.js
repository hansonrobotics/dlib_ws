(function(){"use strict";TS.registerModule("web.file",{file_id:null,onStart:function(){TS.web.login_sig.add(TS.web.file.onLogin,TS.web.file);if(!TS.web.space){TS.files.team_file_changed_sig.add(TS.web.file.teamFileChanged,TS.web.file)}TS.files.team_file_comment_deleted_sig.add(TS.web.file.teamFileCommentDeleted,TS.web.file);TS.files.team_file_deleted_success_sig.add(_teamFileDeleted)},onLogin:function(){if(TS.boot_data.file){TS.utility.makeSureAllExternalLinksAreRefererSafe($(".post_body"));var file=TS.files.upsertFile(TS.boot_data.file).file;TS.web.file.file_id=file.id;var member;if(file.user==="USLACKBOT"&&file.bot_id){member=TS.bots.getBotById(file.bot_id);member.is_bot=true;member.is_service=true}else{member=TS.members.getMemberById(file.user)}$(".action_cog").on("click",function(e){TS.menu.file.startWithFileActions(e,file.id)});$(".file_header_container").html(TS.templates.file_header({file:file,download:file.mode==="hosted",member:member,is_post:file.mode==="space"||file.mode==="post",preview:true}));if(file.mode==="email"){var template_args={file:file,show_file_actions_cog:false,to_more_count:file.to.length-1,cc_more_count:file.cc.length-1};$("#file_page_email").html(TS.templates.file_email(template_args))}$(".star").bind("click.file",TS.stars.checkForStarClick);$("#file_public_link_revoker").bind("click",function(){TS.web.file.revokePublicURL(file)});$("#post_share_btn").on("click",function(){TS.ui.share_dialog.start(TS.web.file.file_id)});if(TS.web.comments&&!TS.web.space){TS.files.fetchFileInfo(file.id,function(id,file){TS.web.comments.renderComments(file)})}}if(_.get(TS,"files.media")){TS.files.media.bindVideoElements({onCanplay:_onVideoCanplay,onError:_onVideoError})}$("#snippet_expand_toggle").on("click",function(){$(this).find("i").toggleClass("hidden");$("#page_contents").toggleClass("full_width");var expand_snippets;if(TS.model.prefs.expand_snippets){expand_snippets=false}else{expand_snippets=true}TS.model.prefs.expand_snippets=expand_snippets;TS.prefs.setPrefByAPI({name:"expand_snippets",value:expand_snippets})});$(".guide_toggle").on("click",function(){$("#formatting_col").toggleClass("hidden");$("#post_col").toggleClass("span_4_of_6 span_1_of_1");$(".guide_toggle").toggleClass("hidden");var posts_formatting_guide;if(TS.model.prefs.posts_formatting_guide){posts_formatting_guide=false}else{posts_formatting_guide=true}TS.model.prefs.posts_formatting_guide=posts_formatting_guide;TS.prefs.setPrefByAPI({name:"posts_formatting_guide",value:posts_formatting_guide})});setTimeout(function(){$("#title").focus()},0)},revokePublicURL:function(file){var title=TS.i18n.t("Revoke public file link","files")();var msg="<p>"+TS.i18n.t("This will disable the Public Link for this file, and will cause any previously shared links to stop working.","files")()+"</p>";msg+=TS.i18n.t("Are you sure you want to revoke this public link?","files")();if(TS.boot_data.feature_external_files){title=TS.i18n.t("Revoke external file link","files")();msg="<p>"+TS.i18n.t("This will disable the External Link for this file, and will cause any previously shared links to stop working.","files")()+"</p>";msg+=TS.i18n.t("Are you sure you want to revoke this external link?","files")()}TS.generic_dialog.start({title:title,body:msg,show_cancel_button:true,show_go_button:true,go_button_text:TS.i18n.t("Revoke it","files")(),go_button_class:"btn_warning",onGo:function(){$(".file_public_link_shared").slideToggle(100);TS.files.upsertAndSignal({id:file.id,public_url_shared:false});TS.api.callImmediately("files.revokePublicURL",{file:file.id},function(ok,data){if(data.file){TS.files.upsertAndSignal(data.file);TS.files.user_changed_public_url_sig.dispatch(data.file)}})}})},teamFileChanged:function(file){$(".file_public_link").attr("href",file.permalink_public);if(file.public_url_shared){$(".file_public_link_shared").slideDown(100)}else{$(".file_public_link_shared").slideUp(100)}var title=TS.emoji.graphicReplace(file.title);$("#file_title").html(title);TS.web.comments.renderComments(file)},teamFileCommentDeleted:function(file,comment_id){TS.ui.comments.removeFileComment(file,comment_id)},onPostShare:function(ok,data,args){var model_ob=TS.shared.getModelObById(args.channel);var share_name=model_ob.name;var name_for_url=TS.boot_data.feature_intl_channel_names?model_ob.id:model_ob.name;if(model_ob.is_channel)share_name="#"+model_ob.name;var $share_msg=$('<p id="file_share_alert" class="alert alert_success no_print"><i class="ts_icon ts_icon_check_circle_o"></i> File shared to <a href="/archives/'+name_for_url+'">'+share_name+"</a>.</p>");if($("#file_share_alert").length){$("#file_share_alert").replaceWith($share_msg)}else{$(".alert_container").append($share_msg)}$("#draft_mode_alert").remove();$("#post_status_draft").remove();if(model_ob.is_channel){$("#post_status_private").remove()}},deleteFile:function(file_id){var msg_title;var msg_body;var msg_go_button_text;var obj=TS.files&&TS.files.getFileById?TS.files.getFileById(file_id):null;if(obj&&obj.filetype&&obj.filetype==="space"){msg_title=TS.i18n.t("Delete post","files")();msg_body=TS.i18n.t("Are you sure you want to delete this post permanently?","files")();msg_go_button_text=TS.i18n.t("Yes, delete this post","files")()}else{msg_title=TS.i18n.t("Delete file","files")();msg_body=TS.i18n.t("Are you sure you want to delete this file permanently?","files")();msg_go_button_text=TS.i18n.t("Yes, delete this file","files")()}TS.generic_dialog.start({title:msg_title,body:msg_body,show_cancel_button:true,show_go_button:true,go_button_class:"btn_danger",go_button_text:msg_go_button_text,cancel_button_text:TS.i18n.t("Cancel","files")(),onGo:function(){TS.api.call("files.delete",{file:file_id},TS.web.file.onFileDelete)}})},onFileDelete:function(ok,data,args){if(!ok){TS.generic_dialog.alert(TS.i18n.t("There was a problem deleting this file. Please try again.","files")());return}TS.files.team_file_deleted_success_sig.dispatch(args.file)},test:function(){return{_teamFileDeleted:_teamFileDeleted}}});var _teamFileDeleted=function(file_id){if(file_id!=TS.web.file.file_id)return;if(TS.web&&TS.web.space&&TS.web.space.isAutomaticDeleteInProcess())return;TS.generic_dialog.start({body:"<p>"+TS.i18n.t("This file has been deleted!","files")()+"</p>",show_cancel_button:false,esc_for_ok:true,onGo:function(){var is_ssb=TSSSB.env.desktop_app_version!=null;if(is_ssb){window.close()}else{document.location.replace("/files")}},unique:"file_deleted_"+file_id})};var _onVideoCanplay=function($el){$el.parent().removeClass("span_1_of_2");$el.removeClass("hidden")};var _onVideoError=function($el){$el.closest(".filetype_button_web").removeClass("hidden")}})();
