(function(){"use strict";TS.registerModule("web.comments",{onStart:function(){TS.web.comments.bindForm($("#file_comment_form"))},submitFileComment:function(){var $comment_button=$("#file_comment_submit_btn");var $comment_field=$("#file_comment_form #file_comment");var comment_original=TS.utility.contenteditable.value($comment_field);var comment=TS.format.cleanMsg(comment_original);if(!$.trim(comment)){return}var file=TS.files.getFileById(TS.web.file.file_id);var file_id=file.id;var channel_id;var key_word=TS.ui.needToBlockAtChannelKeyword(comment_original,file);if(key_word){TS.generic_dialog.alert("<p>"+TS.i18n.t("A Team Owner has restricted the use of <strong>{at_channel_key_word}</strong> messages.","comments")({at_channel_key_word:_.escape(key_word)}));return}var $new_comment;TS.utility.contenteditable.clear($comment_field);TS.utility.contenteditable.clearHistory($comment_field);if($comment_button.data("ladda")===undefined){$comment_button.data("ladda",Ladda.create($comment_button[0]))}$comment_button.data("ladda").start();TS.files.addComment(file_id,comment,channel_id,function(ok,data,args){if(ok){TS.files.fetchFileInfo(file.id,function(id,file){TS.web.comments.renderComments(file);if(data.comment.id){if(window.location.hash&&history&&history.pushState){history.pushState({},"","#"+data.comment.id)}$new_comment=$("#"+data.comment.id);if($new_comment){$new_comment.scrollintoview()}}$comment_button.data("ladda").stop()})}else{alert(TS.i18n.t("error: comment not added to file","comments")());if(args.file==file_id){TS.utility.contenteditable.value($comment_field,comment_original)}}})},bindForm:function(form){form.bind("submit",function(e){e.preventDefault();TS.web.comments.submitFileComment();return false})},renderCommentsIfNotYetRendered:function(file){if(_rendered_once)return;_rendered_once=true;TS.web.comments.renderComments(file)},renderComments:function(file){var template_args={};var target_div;template_args.file=file;target_div=$("#file_page_comments");target_div.html(TS.templates.comments(template_args));target_div.unbind("click.comments").bind("click.comments",function(e){TS.stars.checkForStarClick(e);TS.rxns.checkForRxnClick(e);var $el=$(e.target);var comment_actions_el=$el.closest(".comment_actions");if(comment_actions_el.length==1){TS.info("click on child of .comment_actions");if($el.hasClass("comment_cog")){e.preventDefault();TS.menu.startWithCommentActions(e,comment_actions_el.data("file-id"),comment_actions_el.data("comment-id"))}}});$(".file_comment_tip").html(TS.templates.builders.makeFileCommentHelpHTML(file));if(window.location.hash){var comment_div=$(window.location.hash);var header_height=92;$(window).scrollTop(comment_div.offset().top-header_height)}}});var _rendered_once=false})();
